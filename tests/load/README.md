# è´Ÿè½½æµ‹è¯•æŒ‡å—

## å‰ç½®è¦æ±‚

### å®‰è£… k6

**macOS:**
```bash
brew install k6
```

**Linux:**
```bash
# Debian/Ubuntu
sudo gpg -k
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

## âš ï¸ å®‰å…¨ç¬¬ä¸€ï¼

**é‡è¦æç¤ºï¼š** k6 **ä¸ä¼š**æ ¹æ®æœåŠ¡å™¨å¥åº·çŠ¶å†µè‡ªåŠ¨è°ƒæ•´è´Ÿè½½ã€‚å³ä½¿æœåŠ¡å™¨å¿«è¦å´©æºƒï¼Œå®ƒä¹Ÿä¼šæŒç»­å‘é€è¯·æ±‚ï¼

### æµ‹è¯•å‰å‡†å¤‡

1. **åœ¨å•ç‹¬çš„ç»ˆç«¯ç›‘æ§æœåŠ¡å™¨**ï¼š
   ```bash
   # ç›‘æ§ CPUã€å†…å­˜ã€è´Ÿè½½
   htop

   # æˆ–è€…ä½¿ç”¨ Docker
   docker stats
   ```

2. **ä»å®‰å…¨æµ‹è¯•å¼€å§‹**ï¼ˆæ¨èï¼‰ï¼š
   ```bash
   k6 run tests/load/k6-safe.js
   ```

   æ­¤æµ‹è¯•å…·æœ‰**è‡ªåŠ¨ä¸­æ­¢é˜ˆå€¼**ï¼š
   - é”™è¯¯ç‡ > 10% æ—¶ä¸­æ­¢
   - P95 å»¶è¿Ÿ > 5s æ—¶ä¸­æ­¢

3. **å‡†å¤‡å¥½ç´§æ€¥åœæ­¢**ï¼š
   ```bash
   # æŒ‰ Ctrl+C ç«‹å³åœæ­¢ k6
   ```

### è­¦å‘Šä¿¡å·ï¼ˆç«‹å³åœæ­¢æµ‹è¯•ï¼ï¼‰

| æŒ‡æ ‡ | è­¦å‘Š | å±é™© - ç«‹å³åœæ­¢ï¼ |
|------|------|------------------|
| **CPU** | > 80% | > 95% |
| **å†…å­˜** | > 80% | > 90% |
| **è´Ÿè½½å¹³å‡å€¼** | > CPU æ ¸æ•° | > 2å€æ ¸æ•° |
| **é”™è¯¯ç‡** | > 5% | > 10% |
| **å“åº”æ—¶é—´** | > 2s | > 5s |

å¦‚æœçœ‹åˆ°**å±é™©**çº§åˆ«çš„å€¼ï¼Œ**ç«‹å³åœæ­¢æµ‹è¯•**ï¼ˆCtrl+Cï¼‰ï¼

## è¿è¡Œæµ‹è¯•

### 1. å¯åŠ¨ API æœåŠ¡å™¨

```bash
# æ„å»ºå¹¶è¿è¡Œ
make build
make run-server

# æˆ–ä½¿ç”¨ Docker
docker run -d -p 1279:1279 palemoky/chinese-poetry-api:latest
```

### 2. è¿è¡Œè´Ÿè½½æµ‹è¯•

#### ğŸ›¡ï¸ å®‰å…¨æ¸è¿›æµ‹è¯•ï¼ˆä»è¿™é‡Œå¼€å§‹ï¼ï¼‰
```bash
k6 run tests/load/k6-safe.js
```

**ç‰¹æ€§ï¼š**
- ä» 10 â†’ 50 â†’ 100 â†’ 200 ç”¨æˆ·é€æ­¥å¢åŠ 
- é”™è¯¯ç‡ > 10% æˆ–å»¶è¿Ÿ > 5s æ—¶è‡ªåŠ¨ä¸­æ­¢
- é€‚åˆé¦–æ¬¡æµ‹è¯•

#### åŸºç¡€è´Ÿè½½æµ‹è¯•
```bash
k6 run tests/load/k6-test.js
```

#### âš ï¸ å‹åŠ›æµ‹è¯•ï¼ˆè°¨æ…ä½¿ç”¨ï¼ï¼‰
```bash
k6 run tests/load/k6-stress.js
```

**è­¦å‘Šï¼š** æ­¤æµ‹è¯•æœ€é«˜è¾¾åˆ° 2000 å¹¶å‘ç”¨æˆ·ï¼
- å¯†åˆ‡ç›‘æ§æœåŠ¡å™¨
- éšæ—¶å‡†å¤‡ç”¨ Ctrl+C åœæ­¢
- å¯èƒ½å¯¼è‡´ä¸´æ—¶æœåŠ¡é™çº§

**é¢„æœŸç»“æœï¼š**
- ç›®æ ‡ï¼š1000-2000 å¹¶å‘ç”¨æˆ·
- å¸®åŠ©è¯†åˆ«æœ€å¤§å®¹é‡
- å³°å€¼æ—¶å¯èƒ½å‡ºç°å»¶è¿Ÿå¢åŠ å’Œé”™è¯¯

#### âš ï¸ å°–å³°æµ‹è¯•ï¼ˆæé™è´Ÿè½½ï¼ï¼‰
```bash
k6 run tests/load/k6-spike.js
```

**è­¦å‘Šï¼š** çªç„¶ 20 å€æµé‡æ¿€å¢ï¼
- ä»…åœ¨å‹åŠ›æµ‹è¯•æˆåŠŸåè¿è¡Œ
- æœåŠ¡å™¨å¯èƒ½æš‚æ—¶æ— å“åº”
- å‡†å¤‡å¥½ç›‘æ§å·¥å…·

**é¢„æœŸç»“æœï¼š**
- æ¨¡æ‹Ÿçªç„¶ 20 å€æµé‡å¢åŠ 
- æµ‹è¯•è‡ªåŠ¨æ‰©å±•å’Œæ¢å¤èƒ½åŠ›

### 3. è‡ªå®šä¹‰é…ç½®

#### è¦†ç›–åŸºç¡€ URLï¼š
```bash
k6 run -e BASE_URL=http://your-server:1279 tests/load/k6-test.js
```

#### è°ƒæ•´è™šæ‹Ÿç”¨æˆ·æ•°ï¼š
```bash
# ä½¿ç”¨æ›´å°‘ç”¨æˆ·çš„å¿«é€Ÿæµ‹è¯•
k6 run --vus 10 --duration 30s tests/load/k6-test.js
```

#### ä¿å­˜ç»“æœåˆ°æ–‡ä»¶ï¼š
```bash
k6 run --out json=results.json tests/load/k6-test.js
```

## è§£è¯»ç»“æœ

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ä¼˜ç§€ | å¯æ¥å— | è¾ƒå·® |
|------|------|--------|------|
| **http_req_duration (p95)** | < 200ms | < 500ms | > 1s |
| **http_req_duration (p99)** | < 500ms | < 1s | > 2s |
| **http_req_failed** | < 0.1% | < 1% | > 5% |
| **Requests/sec** | > 1000 | > 500 | < 100 |

### ç¤ºä¾‹è¾“å‡º

```
     âœ“ list poems status 200
     âœ“ random poem status 200
     âœ“ search status 200

     checks.........................: 99.50% âœ“ 29850    âœ— 150
     data_received..................: 245 MB 1.6 MB/s
     data_sent......................: 2.8 MB 18 kB/s
     http_req_blocked...............: avg=12.45Âµs  p(95)=25.3Âµs  p(99)=45.2Âµs
     http_req_duration..............: avg=125.34ms p(95)=285.4ms p(99)=456.7ms
     http_reqs......................: 30000  200/s
     iteration_duration.............: avg=5.12s    p(95)=5.45s   p(99)=5.89s
     iterations.....................: 6000   40/s
     vus............................: 100    min=0     max=200
```

## ä¼˜åŒ–å»ºè®®

### å¦‚æœé‡åˆ°é«˜å»¶è¿Ÿï¼š

1. **æ•°æ®åº“å·²è‡ªåŠ¨ä¼˜åŒ–ï¼š**
   - SQLite PRAGMA è®¾ç½®ï¼ˆWALã€ç¼“å­˜ç­‰ï¼‰å·²è‡ªåŠ¨åº”ç”¨
   - è¿æ¥æ± æ ¹æ® CPU æ ¸æ•°è‡ªåŠ¨è°ƒæ•´
   - æ— éœ€æ‰‹åŠ¨é…ç½® âœ…

2. **è°ƒæ•´è¿æ¥æ± **ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰ï¼š
   ```bash
   # docker-compose.yml
   environment:
     - DB_MAX_OPEN_CONNS=30
     - DB_MAX_IDLE_CONNS=15
   ```

3. **æ·»åŠ ç¼“å­˜å±‚**ï¼ˆç”¨äºæé™è´Ÿè½½ï¼‰ï¼š
   - Redis ç”¨äºæŸ¥è¯¢ç»“æœ
   - å†…å­˜ç¼“å­˜ç”¨äºçƒ­æ•°æ®

### å¦‚æœé‡åˆ°é«˜é”™è¯¯ç‡ï¼š

1. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ä¸­çš„é”™è¯¯
2. ç›‘æ§ç³»ç»Ÿèµ„æºï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ I/Oï¼‰
3. éªŒè¯æ•°æ®åº“è¿æ¥æ± è®¾ç½®

## æŒç»­ç›‘æ§

å¯¹äºç”Ÿäº§ç¯å¢ƒç›‘æ§ï¼Œè€ƒè™‘ï¼š
- **Grafana k6 Dashboard**ï¼šå®æ—¶å¯è§†åŒ–
- **Prometheus**ï¼šæŒ‡æ ‡æ”¶é›†
- **å‘Šè­¦**ï¼šä¸ºæ€§èƒ½é™çº§è®¾ç½®å‘Šè­¦
