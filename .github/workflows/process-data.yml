name: Process and Release Poetry Data

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.0'  # Only trigger on v*.*.0 tags (e.g., v0.1.0, v0.2.0, v1.0.0)
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  process-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install dependencies
        run: go mod download

      - name: Build processor
        run: go build -o processor ./cmd/processor
        env:
          CGO_ENABLED: 1

      - name: Process poetry data
        run: |
          ./processor \
            --input poetry-data \
            --output poetry.db \
            --workers 8

      - name: Compress databases
        run: |
          gzip -9 poetry.db
          sha256sum *.db.gz > checksums.txt

      - name: Collect statistics
        id: stats
        run: |
          # è§£å‹ä¸´æ—¶ç»Ÿè®¡
          gunzip -k poetry.db.gz

          # ç»Ÿè®¡æ•°æ®
          POEMS=$(sqlite3 poetry.db 'SELECT COUNT(*) FROM poems_zh_hans')
          AUTHORS=$(sqlite3 poetry.db 'SELECT COUNT(*) FROM authors_zh_hans')
          DYNASTIES=$(sqlite3 poetry.db 'SELECT COUNT(*) FROM dynasties_zh_hans')

          echo "poems=$POEMS" >> $GITHUB_OUTPUT
          echo "authors=$AUTHORS" >> $GITHUB_OUTPUT
          echo "dynasties=$DYNASTIES" >> $GITHUB_OUTPUT

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm poetry.db

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          make_latest: true
          files: |
            poetry.db.gz
            checksums.txt
          body: |
            ## è¯—è¯æ•°æ®åº“ ${{ github.ref_name }}

            ### ğŸ“Š æ•°æ®ç»Ÿè®¡
            | é¡¹ç›® | æ•°é‡ |
            |------|------|
            | è¯—è¯æ€»æ•° | ${{ steps.stats.outputs.poems }} |
            | ä½œè€…æ•°é‡ | ${{ steps.stats.outputs.authors }} |
            | æœä»£æ•°é‡ | ${{ steps.stats.outputs.dynasties }} |

            ### ğŸ“¦ æ–‡ä»¶è¯´æ˜
            | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|
            | `poetry.db.gz` | ç»Ÿä¸€æ•°æ®åº“ï¼ˆåŒ…å«ç®€ä½“å’Œç¹ä½“è¡¨ï¼‰ |
            | `checksums.txt` | SHA256 æ ¡éªŒå’Œ |

            ### ğŸŒ å¤šè¯­è¨€æ”¯æŒ
            API é€šè¿‡ `?lang=` å‚æ•°åˆ‡æ¢ï¼š
            - `zh-Hans` - ç®€ä½“ä¸­æ–‡ï¼ˆé»˜è®¤ï¼‰
            - `zh-Hant` - ç¹ä½“ä¸­æ–‡

            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            å®¹å™¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ä¸‹è½½æ•°æ®åº“ï¼Œæ— éœ€æ‰‹åŠ¨ä¸‹è½½ã€‚

            ```bash
            docker run -d -p 1279:1279 palemoky/chinese-poetry-api:latest
            ```

            è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README](https://github.com/${{ github.repository }}#readme)

      - name: Notify Success
        if: success() && github.event_name != 'pull_request'
        run: |
          if [ -n "${{ vars.SPEAKER_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ vars.SPEAKER_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.SPEAKER_TOKEN }}" \
            -H "CF-Access-Client-Id: ${{ secrets.CF_CLIENT_ID }}" \
            -H "CF-Access-Client-Secret: ${{ secrets.CF_CLIENT_SECRET }}" \
            -d '{"message": "${{ github.event.repository.name }}: poetry data ${{ github.ref_name }} has been processed and released!"}' || true
          fi

      - name: Notify Failure
        if: failure() && github.event_name != 'pull_request'
        run: |
          if [ -n "${{ vars.SPEAKER_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ vars.SPEAKER_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.SPEAKER_TOKEN }}" \
            -H "CF-Access-Client-Id: ${{ secrets.CF_CLIENT_ID }}" \
            -H "CF-Access-Client-Secret: ${{ secrets.CF_CLIENT_SECRET }}" \
            -d '{"message": "${{ github.event.repository.name }}: Mayday! Mayday! Poetry data ${{ github.ref_name }} processing failed. Check the logs."}' || true
          fi
